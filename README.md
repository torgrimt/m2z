# MQTT to Zabbix Bridge (Perl Script)

This script bridges an MQTT broker (like Zigbee2MQTT) and a Zabbix monitoring server. It subscribes to MQTT topics, parses JSON sensor data, and forwards metrics to Zabbix using `zabbix_sender`. This allows monitoring of MQTT-enabled IoT devices in Zabbix.

## How It Works

1.  **MQTT Subscription**: Uses the `Net::MQTT::Simple` Perl module to listen for messages on a configured topic pattern (e.g., `zigbee2mqtt/+`).
2.  **Message Parsing**: Extracts a device ID from the topic and uses `JSON` module to parse metric values from the JSON payload.
3.  **Data Forwarding**: Sends extracted metrics to Zabbix via `zabbix_sender` with dynamically constructed item keys (e.g., `z2m.metric[DeviceID]`).

## Dependencies

* Perl 5.10 or newer
* Perl modules:
  * `Net::MQTT::Simple`
  * `JSON`
  * `Data::Dumper` (for debugging)
  * `File::Basename`
* `zabbix_sender`

These are included in the provided `Dockerfile`.

## Configuration

Configure via environment variables. Key variables include:

* MQTT connection details: `MQTT_BROKER_HOST`, `MQTT_BROKER_PORT`, `MQTT_USERNAME`, `MQTT_PASSWORD`
* MQTT topic settings: `MQTT_TOPIC_PATTERN`, `MQTT_TOPIC_DEVICE_ID_SEGMENT_INDEX`
* Zabbix server details: `ZABBIX_SERVER_HOST`, `ZABBIX_SERVER_PORT`, `ZABBIX_MONITORED_HOSTNAME`
* Metric-specific settings: `ENABLE_TEMP`, `ZABBIX_KEY_TEMP` (e.g., `"z2m.temperature[__DEVICE_ID__]"`), `JSON_FIELD_TEMP` (e.g., `"temperature"`) for each metric (humidity, pressure, etc.).

**Note on Placeholder:** The script uses `__DEVICE_ID__` in Zabbix key templates, which it replaces with the actual device name.

## Docker Usage

1.  **Build:**
    ```bash
    docker build -t mqtt-zabbix-bridge-perl .
    ```

2.  **Run:**
    ```bash
    docker run -d --name my-mqtt-zabbix-instance \
      -e MQTT_BROKER_HOST="your_mqtt_broker_ip" \
      -e MQTT_TOPIC_PATTERN="zigbee2mqtt/+" \
      -e ZABBIX_SERVER_HOST="your_zabbix_server_ip" \
      -e ZABBIX_MONITORED_HOSTNAME="ZigbeeSensorsHost" \
      -e ZABBIX_KEY_TEMP="z2m.temperature[__DEVICE_ID__]" \
      -e JSON_FIELD_TEMP="temperature" \
      # Add other necessary environment variables
      --restart unless-stopped \
      mqtt-zabbix-bridge-perl
    ```

3.  **Logs:**
    ```bash
    docker logs my-mqtt-zabbix-instance -f
    ```

## Testing with `mosquitto_pub`

Publish a sample message to test (replace `YOUR_MQTT_BROKER_IP`):
```bash
mosquitto_pub -h YOUR_MQTT_BROKER_IP -p 1883 \
  -t "zigbee2mqtt/MyTestSensor" \
  -m '{"battery":95,"humidity":45.2,"linkquality":200,"power_outage_count":1,"pressure":1010.5,"temperature":23.8,"voltage":3010}'
```

The script should send data for keys like `z2m.temperature[MyTestSensor]`.

## Zabbix Configuration

Ensure a Host in Zabbix matches `ZABBIX_MONITORED_HOSTNAME`.
Create Items for this host with keys matching those generated by the script (e.g., `z2m.temperature[MyTestSensor]`).
- Type: Zabbix trapper
- Type of information: Appropriate for the data (e.g., Float for temperature)
