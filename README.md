# MQTT to Zabbix Bridge (Perl Script)

This script bridges an MQTT broker (like Zigbee2MQTT) and a Zabbix monitoring server. It subscribes to MQTT topics, parses JSON sensor data, and forwards metrics to Zabbix using `zabbix_sender`. This allows monitoring of MQTT-enabled IoT devices in Zabbix.

## How It Works

1.  **MQTT Subscription**: Uses `mosquitto_sub` to listen for messages on a configured topic pattern (e.g., `zigbee2mqtt/+`).
2.  **Message Parsing**: Extracts a device ID from the topic and uses `jq` to parse metric values from the JSON payload.
3.  **Data Forwarding**: Sends extracted metrics to Zabbix via `zabbix_sender` with dynamically constructed item keys (e.g., `z2m.metric[DeviceID]`).

## Dependencies

* Perl 5.10 or newer
* External commands used by the script:
  * `mosquitto_sub`
  * `jq`
  * `zabbix_sender`
  * `awk`
  * `od` (for debug logging)

These are included in the provided `Dockerfile`.

## Configuration

Configure via environment variables. Key variables include:

* MQTT connection details: `MQTT_BROKER_HOST`, `MQTT_BROKER_PORT`, `MQTT_USERNAME`, `MQTT_PASSWORD`, `MQTT_CLIENT_ID`
* MQTT topic settings: `MQTT_TOPIC_PATTERN`, `MQTT_TOPIC_DEVICE_ID_SEGMENT_INDEX`
* Zabbix server details: `ZABBIX_SERVER_HOST`, `ZABBIX_SERVER_PORT`, `ZABBIX_MONITORED_HOSTNAME`
* Metric-specific settings:
  * Temperature: `ENABLE_TEMP`, `ZABBIX_KEY_TEMP` (e.g., `"z2m.temperature[__DEVICE_ID__]"`), `JSON_FIELD_TEMP` (e.g., `".temperature"`)
  * Humidity: `ENABLE_HUMID`, `ZABBIX_KEY_HUMID`, `JSON_FIELD_HUMID`
  * Pressure: `ENABLE_PRESSURE`, `ZABBIX_KEY_PRESSURE`, `JSON_FIELD_PRESSURE`
  * Battery: `ENABLE_BATTERY`, `ZABBIX_KEY_BATTERY`, `JSON_FIELD_BATTERY`
  * Link Quality: `ENABLE_LINKQUALITY`, `ZABBIX_KEY_LINKQUALITY`, `JSON_FIELD_LINKQUALITY`
  * Voltage: `ENABLE_VOLTAGE`, `ZABBIX_KEY_VOLTAGE`, `JSON_FIELD_VOLTAGE`
  * Power Outage Count: `ENABLE_POWER_OUTAGE`, `ZABBIX_KEY_POWER_OUTAGE`, `JSON_FIELD_POWER_OUTAGE`
* Logging: `LOG_LEVEL` (DEBUG, INFO, WARN, ERROR)

**Note on Placeholder:** The script uses `__DEVICE_ID__` in Zabbix key templates, which it replaces with the actual device name.

## Docker Usage

1.  **Build:**
    ```bash
    docker build -t mqtt-zabbix-bridge-perl .
    ```

2.  **Run:**
    ```bash
    docker run -d --name my-mqtt-zabbix-instance \
      -e MQTT_BROKER_HOST="your_mqtt_broker_ip" \
      -e MQTT_TOPIC_PATTERN="zigbee2mqtt/+" \
      -e ZABBIX_SERVER_HOST="your_zabbix_server_ip" \
      -e ZABBIX_MONITORED_HOSTNAME="ZigbeeSensorsHost" \
      -e ZABBIX_KEY_TEMP="z2m.temperature[__DEVICE_ID__]" \
      -e JSON_FIELD_TEMP=".temperature" \
      -e LOG_LEVEL="INFO" \
      # Add other necessary environment variables
      --restart unless-stopped \
      mqtt-zabbix-bridge-perl
    ```

3.  **Logs:**
    ```bash
    docker logs my-mqtt-zabbix-instance -f
    ```

## Testing with `mosquitto_pub`

Publish a sample message to test (replace `YOUR_MQTT_BROKER_IP`):
```bash
mosquitto_pub -h YOUR_MQTT_BROKER_IP -p 1883 \
  -t "zigbee2mqtt/MyTestSensor" \
  -m '{"battery":95,"humidity":45.2,"linkquality":200,"power_outage_count":1,"pressure":1010.5,"temperature":23.8,"voltage":3010}'
```

The script should send data for keys like `z2m.temperature[MyTestSensor]`.

## Zabbix Configuration

Ensure a Host in Zabbix matches `ZABBIX_MONITORED_HOSTNAME`.
Create Items for this host with keys matching those generated by the script (e.g., `z2m.temperature[MyTestSensor]`).
- Type: Zabbix trapper
- Type of information: Appropriate for the data (e.g., Float for temperature)
